<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="xmt.item.webapp.dao.OrderDao">
<!--新增订单-->
    <insert id="orderAdd" parameterType="xmt.item.webapp.entity.OrderInfo">
        insert into
        sys_order
        (id,user_id,address_id,total_price,all_count,state,create_time,store_id,update_time)
        values
        (#{id},#{userId},#{addressId},#{totalPrice},#{allCount},#{state},now(),#{storeId},now())
    </insert>
<!--    新增订单详情-->
    <insert id="orderDetailAdd" parameterType="xmt.item.webapp.entity.OrderDetailInfo">
        insert into
        sys_order_detail
        (order_id,g_id,g_name,g_desc,g_img,g_count,g_price,create_time,update_time)
        values
        (#{orderId},#{goodsId},#{goodsName},#{goodsDesc},#{goodsImg},#{goodsCount},#{goodsPrice},now(),now())
    </insert>
<!--    查询订单-->
    <select id="orderList" parameterType="xmt.item.webapp.entity.OrderInfo" resultType="xmt.item.webapp.entity.OrderInfo">
        select
        a.id id,a.address_id addressId,a.total_price totalPrice,a.all_count allCount,a.state state,
        a.create_time createTime,b.store_name storeName
        from
        sys_order a,sys_store b
        where
        a.store_id = b.id
        and
        a.user_id = #{userId}
        <if test="state != null and state != ''">
        and
            a.state = #{state}
        </if>
        order by
        a.update_time
        desc
    </select>
<!--    查询订单详情-->
    <select id="orderDetailList" parameterType="xmt.item.webapp.entity.OrderDetailInfo" resultType="xmt.item.webapp.entity.OrderDetailInfo">
        select
        id id,order_id orderId, g_id goodsId,g_name goodsName,g_img goodsImg,g_desc goodsDesc,g_count goodsCount,g_price goodsPrice
        from
        sys_order_detail
        where
        order_id = #{orderId}
    </select>
<!--    通过id查询订单及用户信息-->
    <select id="getOrderById" parameterType="java.lang.String" resultType="xmt.item.webapp.entity.OrderInfo">
        select
        a.id id,a.total_price totalPrice,a.all_count allCount,a.state state,a.create_time createTime,
        b.nickname nickname,b.phone phone,
        d.area_name province,f.area_name city,g.area_name area,
        c.address address
        from
        sys_order a,sys_user b,sys_address c,sys_area d,sys_area f,sys_area g
        where
        a.id = #{id}
        and
        a.user_id = b.id
        and
        a.address_id = c.id
        and
        c.province_id = d.area_id
        and
        c.city_id = f.area_id
        and
        c.area_id = g.area_id
    </select>
<!--    修改订单状态-->
    <update id="updateOrderState" parameterType="xmt.item.webapp.entity.OrderInfo">
        update
        sys_order
        set
        state = #{state},
        update_time = now()
        where
        id = #{id}
    </update>
</mapper>